<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking FTMSP 2025</title>

  <!-- Tailwind e React -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PapaParse e Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [data, setData] = useState([]);
      const [categorias, setCategorias] = useState([]);
      const [categoriaSelecionada, setCategoriaSelecionada] = useState("");
      const [atletaSelecionado, setAtletaSelecionado] = useState(null);

      // Carrega CSV
      useEffect(() => {
        Papa.parse("ranking.csv", {
          download: true,
          header: true,
          complete: (results) => {
            setData(results.data.filter(row => row["Nome"]));
            const cats = [...new Set(results.data.map(row => row["Categoria/Classe"]).filter(Boolean))];
            setCategorias(cats.sort());
          },
        });
      }, []);

      const atletas = data.filter(d => d["Categoria/Classe"] === categoriaSelecionada);

      // Gera gráfico ao selecionar atleta
      useEffect(() => {
        if (atletaSelecionado) {
          const etapas = Object.keys(atletaSelecionado)
            .filter(k => k.startsWith("Etapa") || k.includes("Paulistão"));
          const pontos = etapas.map(k => Number(atletaSelecionado[k]) || 0);

          const ctx = document.getElementById("graficoEtapas");
          if (window.graficoEtapas) window.graficoEtapas.destroy();

          window.graficoEtapas = new Chart(ctx, {
            type: "line",
            data: {
              labels: etapas,
              datasets: [
                {
                  label: "Pontuação",
                  data: pontos,
                  borderColor: "#dc2626",
                  backgroundColor: "rgba(220, 38, 38, 0.15)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.35,
                  pointRadius: 6,
                  pointBackgroundColor: "#dc2626",
                  pointBorderColor: "#fff",
                  pointBorderWidth: 2,
                  hoverRadius: 8,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "#111",
                  titleColor: "#fff",
                  bodyColor: "#fff",
                  padding: 10,
                  displayColors: false,
                },
              },
              scales: {
                x: {
                  ticks: { color: "#4b5563", font: { size: 12, weight: "500" } },
                  grid: { color: "rgba(0,0,0,0.05)" },
                },
                y: {
                  beginAtZero: true,
                  ticks: { color: "#4b5563", font: { size: 12, weight: "500" } },
                  grid: { color: "rgba(0,0,0,0.05)" },
                },
              },
            },
          });
        }
      }, [atletaSelecionado]);

      return (
        <div className="container mx-auto p-4">
          <img src="logoftmsp.png" alt="Logo FTMSP" className="h-24 mb-4 mx-auto" />
          <h1 className="text-3xl font-bold text-red-700 mb-6 text-center">
            Ranking FTMSP 2025
          </h1>

          <p className="text-gray-700 text-center mt-2">
            Clique no nome do atleta para mais detalhes
          </p>

          {/* Seleção de categoria */}
          <div className="mb-6 flex justify-center">
            <select
              className="p-2 border rounded-lg shadow"
              value={categoriaSelecionada}
              onChange={(e) => { setCategoriaSelecionada(e.target.value); setAtletaSelecionado(null); }}
            >
              <option value="">Selecione uma Categoria</option>
              {categorias.map((c, i) => (
                <option key={i} value={c}>{c}</option>
              ))}
            </select>
          </div>

          {/* Tabela de atletas */}
          {categoriaSelecionada && !atletaSelecionado && (
            <table className="min-w-full bg-white rounded-lg shadow overflow-hidden">
              <thead className="bg-red-700 text-white">
                <tr>
                  <th className="py-2 px-4">#</th>
                  <th className="py-2 px-4">Nome</th>
                  <th className="py-2 px-4">Equipe</th>
                  <th className="py-2 px-4">Pontos</th>
                </tr>
              </thead>
              <tbody>
                {(() => {
                  const ordenados = [...atletas].sort((a, b) => b["Pontos"] - a["Pontos"]);
                  let posicao = 1;
                  let posicaoReal = 1;
                  let ultimoPonto = null;

                  return ordenados.map((atleta, index) => {
                    const pontos = Number(atleta["Pontos"]) || 0;
                    if (ultimoPonto !== null && pontos < ultimoPonto) posicao = posicaoReal;
                    ultimoPonto = pontos;
                    posicaoReal++;

                    return (
                      <tr
                        key={index}
                        className="border-b hover:bg-gray-100 cursor-pointer"
                        onClick={() => setAtletaSelecionado(atleta)}
                      >
                        <td className="py-2 px-4">{posicao}º</td>
                        <td className="py-2 px-4">{atleta["Nome"]}</td>
                        <td className="py-2 px-4">{atleta["Equipe"]}</td>
                        <td className="py-2 px-4">{pontos}</td>
                      </tr>
                    );
                  });
                })()}
              </tbody>
            </table>
          )}

          {/* Detalhes do atleta */}
          {atletaSelecionado && (
            <div className="bg-white p-6 rounded-lg shadow mt-6">
              <button
                className="mb-4 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition"
                onClick={() => setAtletaSelecionado(null)}
              >
                ← Voltar
              </button>

              <h2 className="text-2xl font-bold text-red-700 mb-2">{atletaSelecionado["Nome"]}</h2>
              <p className="text-gray-700 mb-2"><b>Equipe:</b> {atletaSelecionado["Equipe"]}</p>
              <p className="text-gray-700 mb-4"><b>Categoria:</b> {atletaSelecionado["Categoria/Classe"]}</p>
              <p className="text-lg font-bold text-gray-900 mb-4">Total de Pontos: {atletaSelecionado["Pontos"]}</p>

              <h3 className="text-xl font-semibold mb-2 text-red-700">Desempenho por Etapa</h3>
              <div className="bg-gray-50 p-4 rounded-2xl shadow-inner">
                <canvas id="graficoEtapas"></canvas>
              </div>

              <ul className="list-disc ml-6 mt-4 text-gray-700">
                {Object.keys(atletaSelecionado)
                  .filter(k => k.startsWith("Etapa") || k.includes("Paulistão"))
                  .map((etapa, i) => (
                    <li key={i}>
                      {etapa}: {atletaSelecionado[etapa] || 0}
                    </li>
                  ))}
              </ul>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
