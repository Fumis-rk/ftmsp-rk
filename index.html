<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking FTM-SP 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

function App() {
  const [dados, setDados] = useState([]);
  const [categoriaSelecionada, setCategoriaSelecionada] = useState("");
  const [atletaSelecionado, setAtletaSelecionado] = useState(null);
  const graficoRef = useRef(null);

  // Carrega CSV
  useEffect(() => {
    Papa.parse("ranking.csv", {
      download: true,
      header: true,
      complete: (result) => setDados(result.data.filter(r => r["Nome"])),
    });
  }, []);

  // Lista de categorias
  const categorias = useMemo(() => {
    const unicas = [...new Set(dados.map(d => d["Categoria/Classe"]).filter(Boolean))];
    return unicas.sort();
  }, [dados]);

  // Atletas filtrados e ordenados com empate
  const atletasFiltrados = useMemo(() => {
    if (!categoriaSelecionada) return [];
    const lista = dados
      .filter(d => d["Categoria/Classe"] === categoriaSelecionada)
      .map(d => ({ ...d, Pontos: Number(d.Pontos) || 0 }))
      .sort((a, b) => b.Pontos - a.Pontos);

    let pos = 1;
    return lista.map((a, i) => {
      if (i > 0 && a.Pontos === lista[i - 1].Pontos) {
        a.posicao = lista[i - 1].posicao;
      } else {
        a.posicao = pos;
      }
      pos++;
      return a;
    });
  }, [dados, categoriaSelecionada]);

  // Cria gráfico do atleta
  useEffect(() => {
    if (!atletaSelecionado || !graficoRef.current) return;

    // seleciona todas as colunas de desempenho
    const etapas = Object.keys(atletaSelecionado)
      .filter(k => !["Nome","Equipe","Categoria/Classe","Pontos"].includes(k));
    const pontos = etapas.map(k => {
      const valor = atletaSelecionado[k];
      const num = Number(valor);
      return isNaN(num) ? 0 : num;
    });

    if (window.graficoEtapas) window.graficoEtapas.destroy();

    window.graficoEtapas = new Chart(graficoRef.current, {
      type: "line",
      data: {
        labels: etapas,
        datasets: [{
          label: "Pontuação",
          data: pontos,
          borderColor: "#dc2626",
          backgroundColor: "rgba(220, 38, 38, 0.15)",
          borderWidth: 3,
          fill: true,
          tension: 0.35,
          pointRadius: 6,
          pointBackgroundColor: "#dc2626",
          pointBorderColor: "#fff",
          pointBorderWidth: 2,
          hoverRadius: 8
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "#111",
            titleColor: "#fff",
            bodyColor: "#fff",
            padding: 10,
            displayColors: false
          }
        },
        scales: {
          x: { ticks: { color: "#4b5563", font: { size: 12, weight: "500" } }, grid: { color: "rgba(0,0,0,0.05)" } },
          y: { beginAtZero: true, ticks: { color: "#4b5563", font: { size: 12, weight: "500" } }, grid: { color: "rgba(0,0,0,0.05)" } }
        }
      }
    });

  }, [atletaSelecionado]);

  return (
    <div className="container mx-auto p-4">
      <img src="logoftmsp.png" alt="Logo FTMSP" className="h-24 mb-4 mx-auto" />
      <h1 className="text-3xl font-bold text-red-700 mb-6 text-center">Ranking FTMSP 2025</h1>
      <p className="text-gray-700 text-center mt-2">Clique no nome do atleta para mais detalhes</p>

      {/* Seleção de categoria */}
      <div className="mb-6 flex justify-center">
        <select
          className="p-2 border rounded-lg shadow"
          value={categoriaSelecionada}
          onChange={e => { setCategoriaSelecionada(e.target.value); setAtletaSelecionado(null); }}
        >
          <option value="">Selecione uma Categoria</option>
          {categorias.map((c, i) => <option key={i} value={c}>{c}</option>)}
        </select>
      </div>

      {/* Tabela de atletas */}
      {categoriaSelecionada && !atletaSelecionado && (
        <table className="min-w-full bg-white rounded-lg shadow overflow-hidden">
          <thead className="bg-red-700 text-white">
            <tr>
              <th className="py-2 px-4">#</th>
              <th className="py-2 px-4">Nome</th>
              <th className="py-2 px-4">Equipe</th>
              <th className="py-2 px-4">Pontos</th>
            </tr>
          </thead>
          <tbody>
            {atletasFiltrados.map((atleta, index) => (
              <tr
                key={index}
                className="border-b hover:bg-gray-100 cursor-pointer"
                onClick={() => setAtletaSelecionado(atleta)}
              >
                <td className="py-2 px-4">{atleta.posicao}º</td>
                <td className="py-2 px-4">{atleta.Nome}</td>
                <td className="py-2 px-4">{atleta.Equipe}</td>
                <td className="py-2 px-4">{atleta.Pontos}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}

      {/* Painel atleta */}
      {atletaSelecionado && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-2/3 relative max-h-[90vh] overflow-y-auto">
            <button
              className="absolute top-3 right-4 text-gray-500 hover:text-red-700 text-xl"
              onClick={() => setAtletaSelecionado(null)}
            >✕</button>
            <h3 className="text-2xl font-bold mb-2 text-red-700">{atletaSelecionado.Nome}</h3>
            <p className="text-gray-600 mb-4">{atletaSelecionado.Equipe} • {atletaSelecionado["Categoria/Classe"]}</p>

            {/* Gráfico */}
            <canvas ref={graficoRef} height="180"></canvas>

            {/* Lista detalhada das etapas */}
            <div className="mt-4">
              <h4 className="font-semibold text-gray-700 mb-2">Detalhes das etapas:</h4>
              <ul className="list-disc ml-6 text-gray-700">
                {Object.keys(atletaSelecionado)
                  .filter(k => !["Nome","Equipe","Categoria/Classe","Pontos"].includes(k))
                  .map((etapa, i) => (
                    <li key={i}>
                      {etapa}: {atletaSelecionado[etapa] || 0}
                    </li>
                  ))}
              </ul>
            </div>

          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
